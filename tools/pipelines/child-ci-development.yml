# STAGES OF OUR BUILD
stages:
  - build
  - test
  - deploy

# Allows manual deployment to qa environment for pre deploy testing purposes.
#include:
#  - local: tools/pipelines/woaccelerator-qa-ci.yml
#    rules:
#      - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
  # - local: deploys.yml
  #   rules:
  #     - if: $CI_COMMIT_BRANCH == "qa"

# Pre-Merge Environment #1 check build and delpoy Docker image using Cloud Build
cu-website:pre_dev_deploy:
  image: google/cloud-sdk:alpine
  stage: deploy
  environment: cu-app-dev1
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" || $CI_COMMIT_REF_NAME == "development"
  before_script:
    - bash tools/gcloud_dev_acc.sh
  # when: manual
  script:
    - bash tools/pre_dev_deploy.sh

# Pre-Merge Environment #2 check build and deploy Docker image using Cloud Build
cu-website:pre_dev_deploy2:
  image: google/cloud-sdk:alpine
  stage: deploy
  environment: cu-app-dev2
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" || $CI_COMMIT_REF_NAME == "development"
  before_script:
    - bash tools/gcloud_dev_acc.sh
  when: manual
  script:
    - bash tools/pre_dev_deploy2.sh


# Build docker image using Cloud Build
cu-website:build:
  image: google/cloud-sdk:alpine
  stage: build
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives" 
    - if: $CI_COMMIT_REF_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives"
    - if: $CI_MERGE_REQUEST_APPROVED == "true" && $GITLAB_USER_LOGIN == "alphabetacreatives"
      changes:
        - apps/*
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives" 
    - if: $CI_COMMIT_REF_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives"
    - if: $CI_MERGE_REQUEST_APPROVED == "true" && $GITLAB_USER_LOGIN == "alphabetacreatives"
      changes:
        - docs/apps/*
  before_script:
    - bash tools/gcloud_dev_acc.sh
 # when: manual
  script:
    - cd venturseed-website
    - tar -czf venturseed-website-dev.tgz *
    - gcloud builds submit venturseed-website-dev.tgz
      --tag us-central1-docker.pkg.dev/venturseed-website-dev/venturseed-website-dev/venturseed-website-dev:$CI_COMMIT_REF_SLUG
  retry: 2

# Deploy the container image to Cloud Run
cu_website:dev_deploy:
  environment: cu-website-dev
  image: google/cloud-sdk:alpine
  stage: deploy
  rules:
   # - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" || $CI_COMMIT_REF_NAME == "development"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives" 
    - if: $CI_COMMIT_REF_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives"
    - if: $CI_MERGE_REQUEST_APPROVED == "true" && $GITLAB_USER_LOGIN == "alphabetacreatives"
      changes:
        - venturseed-website/*
   # - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" || $CI_COMMIT_REF_NAME == "development"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives" 
    - if: $CI_COMMIT_REF_NAME == "development" && $GITLAB_USER_LOGIN == "alphabetacreatives"
    - if: $CI_MERGE_REQUEST_APPROVED == "true" && $GITLAB_USER_LOGIN == "alphabetacreatives"
      changes:
        - docs/venturseed-website/*
  needs: ["cu-website:build"]
  before_script:
    - bash tools/gcloud_dev_acc.sh
  script:
    - gcloud run deploy venturseed-website-dev
      --image us-central1-docker.pkg.dev/venturseed-website-dev/venturseed-website-dev/venturseed-website-dev:$CI_COMMIT_REF_SLUG
      --region us-central1
      --service-account cu-dev-cloud-cd@venturseed-website-dev.iam.gserviceaccount.com
  retry: 2